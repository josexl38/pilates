<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Pilates • Reservas & Asistencia (Demo sin backend)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CDN (demo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM + Babel (demo) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>body{background:#f8fafc}</style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useMemo} = React;

    // ===== Config =====
    const CAPACITY=6;
    const TIMES=["07:00","09:00","18:00"];
    const DAYS_AHEAD=21;

    // ===== Utils =====
    const pad=n=>n.toString().padStart(2,"0");
    const localISO=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const parseLocalISO=iso=>{const [dp,tp]=iso.split("T");const[y,m,dd]=dp.split("-").map(Number);const[hh,mm]=tp.split(":").map(Number);return new Date(y,m-1,dd,hh,mm);};
    const addDays=(b,n)=>{const d=new Date(b);d.setDate(d.getDate()+n);return d;};
    const fmt=d=>d.toLocaleString(undefined,{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});
    const dayKey=d=>d.toISOString().slice(0,10);
    const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);

    // ===== Fake DB (localStorage) =====
    const DB={
      users(){return JSON.parse(localStorage.getItem("pb_users")||"[]");},
      saveUsers(u){localStorage.setItem("pb_users",JSON.stringify(u));},
      bookings(){return JSON.parse(localStorage.getItem("pb_bookings")||"[]");},
      saveBookings(b){localStorage.setItem("pb_bookings",JSON.stringify(b));},
      setCurrent(u){localStorage.setItem("pb_current_user",JSON.stringify(u));},
      current(){return JSON.parse(localStorage.getItem("pb_current_user")||"null");},
    };

    // ===== Auth =====
    function useAuth(){
      const [user,setUser]=useState(null);
      useEffect(()=>{const s=DB.current(); if(s) setUser(s);},[]);
      function login(email,name=""){
        email=email.trim().toLowerCase();
        if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) throw new Error("Correo inválido");
        const us=DB.users();
        let u=us.find(x=>x.email===email);
        if(!u){u={email,name:name||email.split("@")[0],sessions:0};us.push(u);DB.saveUsers(us);}
        else if(name && !u.name){u.name=name;DB.saveUsers(us);}
        DB.setCurrent(u); setUser(u);
      }
      function logout(){DB.setCurrent(null); setUser(null);}
      function reload(){setUser(DB.current());}
      return {user,login,logout,reload};
    }

    // ===== Slots & rules =====
    function generateSlots(){
      const res=[]; const now=new Date();
      for(let i=0;i<DAYS_AHEAD;i++){
        const d0=addDays(now,i);
        for(const t of TIMES){
          const [hh,mm]=t.split(":").map(Number);
          const d=new Date(d0.getFullYear(),d0.getMonth(),d0.getDate(),hh,mm);
          if(d<now) continue;
          res.push(localISO(d));
        }
      }
      return res;
    }
    const capacityFor=(iso,all)=>all.filter(b=>b.slotISO===iso && b.status!=="canceled").length;
    const canChange=b=> (parseLocalISO(b.slotISO)-new Date())/(1000*60*60) >= 24;

    // ===== Mutations =====
    function book(user,slotISO){
      const us=DB.users(); const u=us.find(x=>x.email===user.email); if(!u) throw new Error("Usuario no encontrado");
      const bs=DB.bookings();
      if(bs.some(b=>b.email===u.email && b.slotISO===slotISO && b.status!=="canceled")) throw new Error("Ya reservaste ese horario");
      if(capacityFor(slotISO,bs)>=CAPACITY) throw new Error("Clase llena (6/6)");
      if(u.sessions<=0) throw new Error("No tienes sesiones, pide al admin que te asigne un paquete.");
      u.sessions-=1; DB.saveUsers(us);
      bs.push({id:uid(),email:u.email,slotISO,status:"booked",bookedAt:localISO(new Date())});
      DB.saveBookings(bs);
    }
    function cancelBooking(id){
      const bs=DB.bookings(); const b=bs.find(x=>x.id===id); if(!b) throw new Error("Reserva no encontrada");
      if(b.status==="canceled") return;
      const us=DB.users(); const u=us.find(x=>x.email===b.email);
      const refundable=canChange(b);
      b.status="canceled"; DB.saveBookings(bs);
      if(refundable && u){u.sessions+=1; DB.saveUsers(us);}
    }
    function reschedule(id,newISO){
      const bs=DB.bookings(); const b=bs.find(x=>x.id===id); if(!b) throw new Error("Reserva no encontrada");
      if(!canChange(b)) throw new Error("Solo puedes reprogramar con ≥24 h de anticipación");
      if(capacityFor(newISO,bs)>=CAPACITY) throw new Error("La clase destino está llena");
      // prevenir duplicado mismo usuario mismo horario
      if(bs.some(x=>x.email===b.email && x.slotISO===newISO && x.status!=="canceled")) throw new Error("Ya tienes esa hora reservada");
      b.slotISO=newISO; DB.saveBookings(bs);
    }
    function markAttendance(id,status){
      const bs=DB.bookings(); const b=bs.find(x=>x.id===id); if(!b) throw new Error("Reserva no encontrada");
      if(!["booked","attended","missed"].includes(status)) throw new Error("Estado inválido");
      b.status=status; DB.saveBookings(bs);
    }
    function addSessions(email,n){
      const us=DB.users(); const u=us.find(x=>x.email===email.trim().toLowerCase()); if(!u) throw new Error("Usuario no encontrado");
      u.sessions=Math.max(0,(u.sessions||0)+Number(n)); DB.saveUsers(us);
    }
    function setSessions(email,val){
      const us=DB.users(); const u=us.find(x=>x.email===email.trim().toLowerCase()); if(!u) throw new Error("Usuario no encontrado");
      u.sessions=Math.max(0,Number(val)||0); DB.saveUsers(us);
    }

    // ===== UI Helpers =====
    const Badge=({children})=><span className="inline-flex items-center rounded-full border px-2 py-0.5 text-xs">{children}</span>;
    const Section=({title,right,children})=>(
      <div className="rounded-2xl shadow p-4 bg-white border">
        <div className="flex items-center justify-between mb-3"><h2 className="text-lg font-semibold">{title}</h2>{right}</div>
        {children}
      </div>
    );

    function Login({onLogin}){
      const [name,setName]=useState(""); const [email,setEmail]=useState("");
      return (
        <div className="flex items-end gap-2">
          <div className="flex flex-col">
            <label className="text-xs text-gray-500">Nombre</label>
            <input className="border rounded-lg px-3 py-2 w-44" value={name} onChange={e=>setName(e.target.value)} placeholder="Nombre (opcional)" />
          </div>
          <div className="flex flex-col">
            <label className="text-xs text-gray-500">Correo</label>
            <input className="border rounded-lg px-3 py-2 w-64" value={email} onChange={e=>setEmail(e.target.value)} placeholder="tu@correo.com" />
          </div>
          <button className="border rounded-lg px-3 py-2 hover:bg-gray-50" onClick={()=>{try{onLogin(email,name)}catch(e){alert(e.message)}}}>Entrar</button>
        </div>
      );
    }

    function SlotsGrid({slots,bookings,onBook,currentUser}){
      const grouped=useMemo(()=>{
        const g={}; for(const s of slots){const k=dayKey(parseLocalISO(s));(g[k]=g[k]||[]).push(s);} return g;
      },[slots]);
      return (
        <div className="space-y-4">
          {Object.entries(grouped).map(([d,list])=>(
            <div key={d}>
              <div className="text-sm text-gray-500 mb-1">{new Date(d).toDateString()}</div>
              <div className="grid sm:grid-cols-3 gap-3">
                {list.map(s=>{
                  const cap=capacityFor(s,bookings);
                  const mine=bookings.some(b=>b.email===currentUser?.email && b.slotISO===s && b.status!=="canceled");
                  return (
                    <div key={s} className={`rounded-xl border p-3 flex flex-col gap-2 ${mine?'bg-blue-50':''}`}>
                      <div className="flex items-center justify-between">
                        <div className="font-medium">{fmt(parseLocalISO(s))}</div>
                        <Badge>{cap}/{CAPACITY}</Badge>
                      </div>
                      <button className="rounded-xl border px-3 py-1 text-sm hover:bg-gray-50 disabled:opacity-50"
                        disabled={cap>=CAPACITY||mine||!currentUser}
                        onClick={()=>onBook(s)}>
                        {mine?"Reservado":cap>=CAPACITY?"Clase llena":"Reservar"}
                      </button>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      );
    }

    function MyBookings({user,bookings,allSlots,onCancel,onReschedule}){
      const mine=bookings.filter(b=>b.email===user?.email && b.status!=="canceled")
                         .sort((a,b)=>parseLocalISO(a.slotISO)-parseLocalISO(b.slotISO));
      const futureSlots=allSlots; // ya vienen filtrados al futuro
      return (
        <div className="space-y-3">
          {mine.length===0 && <div className="text-sm text-gray-500">No tienes reservas activas.</div>}
          {mine.map(b=>{
            const start=parseLocalISO(b.slotISO);
            const canEdit=canChange(b);
            return (
              <div key={b.id} className="border rounded-xl p-3 flex flex-wrap items-center justify-between gap-2">
                <div className="space-y-1">
                  <div className="font-medium">{fmt(start)}</div>
                  <div className="text-xs text-gray-500">Estado: {b.status}</div>
                </div>
                <div className="flex flex-wrap items-center gap-2">
                  {canEdit && (
                    <select className="border rounded-lg px-2 py-1 text-sm"
                            defaultValue=""
                            onChange={e=>{if(e.target.value) onReschedule(b,e.target.value)}}>
                      <option value="">Reprogramar a…</option>
                      {futureSlots.map(s=>(<option key={s} value={s}>{fmt(parseLocalISO(s))}</option>))}
                    </select>
                  )}
                  <button className="border rounded-lg px-3 py-1 text-sm hover:bg-gray-50"
                          onClick={()=>onCancel(b)}>
                    Cancelar {canEdit?"(regresa sesión)":"(sin reembolso)"}
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    function AdminPanel({users,bookings,refresh,allSlots}){
      const [email,setEmail]=useState(""); const [delta,setDelta]=useState(4); const [fix,setFix]=useState("");
      const future=bookings.filter(b=>parseLocalISO(b.slotISO)>=new Date())
                           .sort((a,b)=>parseLocalISO(a.slotISO)-parseLocalISO(b.slotISO));
      return (
        <div className="space-y-6">
          <Section title="Asignar paquetes">
            <div className="flex flex-wrap items-end gap-3">
              <div className="flex flex-col">
                <label className="text-xs text-gray-500">Correo del usuario</label>
                <input className="border rounded-lg px-3 py-2" placeholder="cliente@correo.com" value={email} onChange={e=>setEmail(e.target.value)} />
              </div>
              <div className="flex flex-col">
                <label className="text-xs text-gray-500">Agregar sesiones (+)</label>
                <input type="number" className="border rounded-lg px-3 py-2 w-28" value={delta} onChange={e=>setDelta(e.target.value)} />
              </div>
              <button className="border rounded-lg px-3 py-2 hover:bg-gray-50" onClick={()=>{try{addSessions(email,delta);refresh();alert("Sesiones agregadas")}catch(e){alert(e.message)}}}>Agregar</button>
              <div className="text-sm text-gray-400">o</div>
              <div className="flex flex-col">
                <label className="text-xs text-gray-500">Fijar total (=)</label>
                <input type="number" className="border rounded-lg px-3 py-2 w-28" value={fix} onChange={e=>setFix(e.target.value)} />
              </div>
              <button className="border rounded-lg px-3 py-2 hover:bg-gray-50" onClick={()=>{try{setSessions(email,fix);refresh();alert("Sesiones actualizadas")}catch(e){alert(e.message)}}}>Fijar</button>
            </div>
          </Section>

          <Section title="Tomar asistencia / gestionar reservas">
            <div className="space-y-2">
              {future.length===0 && <div className="text-sm text-gray-500">No hay reservas futuras.</div>}
              {future.map(b=>(
                <div key={b.id} className="border rounded-xl p-3 flex flex-wrap items-center justify-between gap-2">
                  <div>
                    <div className="font-medium">{fmt(parseLocalISO(b.slotISO))}</div>
                    <div className="text-xs text-gray-500">{b.email}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Badge>{b.status}</Badge>
                    <button className="border rounded-lg px-3 py-1 text-sm hover:bg-gray-50" onClick={()=>{markAttendance(b.id,"attended");refresh();}}>Asistió</button>
                    <button className="border rounded-lg px-3 py-1 text-sm hover:bg-gray-50" onClick={()=>{markAttendance(b.id,"missed");refresh();}}>Faltó</button>
                    <select className="border rounded-lg px-2 py-1 text-sm"
                            defaultValue=""
                            onChange={e=>{ if(!e.target.value) return; try{ reschedule(b.id,e.target.value); refresh(); }catch(err){ alert(err.message);} }}>
                      <option value="">Reprogramar…</option>
                      {allSlots.map(s=>(<option key={s} value={s}>{fmt(parseLocalISO(s))}</option>))}
                    </select>
                    <button className="border rounded-lg px-3 py-1 text-sm hover:bg-gray-50" onClick={()=>{cancelBooking(b.id);refresh();}}>Cancelar</button>
                  </div>
                </div>
              ))}
            </div>
          </Section>

          <Section title="Usuarios">
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3">
              {users.map(u=>(
                <div key={u.email} className="border rounded-xl p-3">
                  <div className="font-medium">{u.name || u.email}</div>
                  <div className="text-xs text-gray-500">{u.email}</div>
                  <div className="mt-2 text-sm">Sesiones disponibles: <b>{u.sessions||0}</b></div>
                </div>
              ))}
            </div>
          </Section>
        </div>
      );
    }

    function App(){
      const slots=useMemo(()=>generateSlots(),[]);
      const {user,login,logout,reload}=useAuth();
      const [bookings,setBookings]=useState(DB.bookings());
      const [users,setUsers]=useState(DB.users());
      const [tab,setTab]=useState("cliente");

      const refresh=()=>{setBookings(DB.bookings()); setUsers(DB.users()); reload();};

      const handleBook=s=>{try{book(user,s); refresh(); alert("Reserva creada");}catch(e){alert(e.message)}};
      const handleCancel=b=>{try{cancelBooking(b.id); refresh();}catch(e){alert(e.message)}};
      const handleReschedule=(b,newISO)=>{try{reschedule(b.id,newISO); refresh();}catch(e){alert(e.message)}};

      return (
        <div className="min-h-screen p-4 sm:p-6 md:p-8">
          <div className="max-w-6xl mx-auto space-y-6">
            <header className="flex flex-wrap items-center justify-between gap-3">
              <div>
                <h1 className="text-2xl font-bold">Pilates • Reservas & Asistencia</h1>
                <p className="text-sm text-gray-500">Demo con 3 pestañas (sin backend). Capacidad 6. Reprogramación ≥24 h.</p>
              </div>
              <div className="flex items-center gap-2">
                {!user ? <Login onLogin={login}/> :
                  <div className="flex items-center gap-2">
                    <div className="text-sm">Hola, <b>{user.name}</b> (<span className="font-mono">{user.sessions||0}</span> sesiones)</div>
                    <button className="border rounded-lg px-3 py-1 text-sm hover:bg-gray-50" onClick={logout}>Salir</button>
                  </div>}
              </div>
            </header>

            <nav className="flex items-center gap-2">
              {[
                {id:"cliente",label:"Reservar (Cliente)"},
                {id:"mis",label:"Mis reservas"},
                {id:"admin",label:"Panel Admin"},
              ].map(x=>(
                <button key={x.id}
                  className={`px-3 py-2 rounded-xl border text-sm ${tab===x.id?'bg-white shadow':'hover:bg-white/60'}`}
                  onClick={()=>setTab(x.id)}>{x.label}</button>
              ))}
            </nav>

            {tab==="cliente" && (
              <Section title="Calendario de clases" right={<Badge>Capacidad {CAPACITY}</Badge>}>
                {!user && <div className="mb-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded-lg p-2">Inicia sesión con tu correo para reservar.</div>}
                <SlotsGrid slots={slots} bookings={bookings} onBook={handleBook} currentUser={user}/>
              </Section>
            )}

            {tab==="mis" && (
              <Section title="Tus reservas">
                {!user
                  ? <div className="text-sm text-gray-500">Inicia sesión para ver tus reservas.</div>
                  : <MyBookings user={user} bookings={bookings} allSlots={slots} onCancel={handleCancel} onReschedule={handleReschedule}/>
                }
              </Section>
            )}

            {tab==="admin" && (
              <Section title="Administración" right={<span className="text-xs text-gray-400">Demo</span>}>
                <AdminPanel users={users} bookings={bookings} refresh={refresh} allSlots={slots}/>
              </Section>
            )}

            <footer className="text-xs text-gray-400 pt-4">
              <p>Este demo no envía correos ni usa base de datos. Para producción: API (PHP/Laravel o FastAPI), MySQL/PostgreSQL, colas de correo, roles y seguridad.</p>
            </footer>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
