<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Pilates ‚Ä¢ Sistema de Reservas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .glass { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useEffect, useMemo} = React;

    // ===== Config =====
    const CAPACITY = 6;
    const TIMES = ["07:00", "09:00", "18:00"];
    const DAYS_AHEAD = 21;

    // ===== Test Users =====
    const TEST_USERS = [
      { email: "usuario@prueba.com", name: "Cliente Demo", role: "user", sessions: 8 },
      { email: "instructor@prueba.com", name: "Instructor Demo", role: "instructor", sessions: 0 },
      { email: "admin@prueba.com", name: "Admin Demo", role: "admin", sessions: 0 }
    ];

    // ===== Utils =====
    const pad = n => n.toString().padStart(2, "0");
    const localISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const parseLocalISO = iso => {
      const [dp, tp] = iso.split("T");
      const [y, m, dd] = dp.split("-").map(Number);
      const [hh, mm] = tp.split(":").map(Number);
      return new Date(y, m-1, dd, hh, mm);
    };
    const addDays = (b, n) => { const d = new Date(b); d.setDate(d.getDate() + n); return d; };
    const fmt = d => d.toLocaleString(undefined, {weekday: "short", year: "numeric", month: "short", day: "numeric", hour: "2-digit", minute: "2-digit"});
    const dayKey = d => d.toISOString().slice(0, 10);
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    // ===== Fake DB (localStorage) =====
    const DB = {
      users() {
        const stored = JSON.parse(localStorage.getItem("pb_users") || "[]");
        if (stored.length === 0) {
          this.saveUsers(TEST_USERS);
          return TEST_USERS;
        }
        return stored;
      },
      saveUsers(u) { localStorage.setItem("pb_users", JSON.stringify(u)); },
      bookings() { return JSON.parse(localStorage.getItem("pb_bookings") || "[]"); },
      saveBookings(b) { localStorage.setItem("pb_bookings", JSON.stringify(b)); },
      setCurrent(u) { localStorage.setItem("pb_current_user", JSON.stringify(u)); },
      current() { return JSON.parse(localStorage.getItem("pb_current_user") || "null"); },
    };

    // ===== Auth =====
    function useAuth() {
      const [user, setUser] = useState(null);
      
      useEffect(() => {
        const s = DB.current();
        if (s) setUser(s);
      }, []);

      function login(email, password = "") {
        email = email.trim().toLowerCase();
        if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) throw new Error("Correo inv√°lido");
        
        const us = DB.users();
        const u = us.find(x => x.email === email);
        if (!u) throw new Error("Usuario no encontrado");
        
        DB.setCurrent(u);
        setUser(u);
      }

      function logout() {
        DB.setCurrent(null);
        setUser(null);
      }

      function reload() {
        setUser(DB.current());
      }

      return { user, login, logout, reload };
    }

    // ===== Slots & rules =====
    function generateSlots() {
      const res = [];
      const now = new Date();
      for (let i = 0; i < DAYS_AHEAD; i++) {
        const d0 = addDays(now, i);
        for (const t of TIMES) {
          const [hh, mm] = t.split(":").map(Number);
          const d = new Date(d0.getFullYear(), d0.getMonth(), d0.getDate(), hh, mm);
          if (d < now) continue;
          res.push(localISO(d));
        }
      }
      return res;
    }

    const capacityFor = (iso, all) => all.filter(b => b.slotISO === iso && b.status !== "canceled").length;
    const canChange = b => (parseLocalISO(b.slotISO) - new Date()) / (1000 * 60 * 60) >= 24;

    // ===== Mutations =====
    function book(user, slotISO) {
      const us = DB.users();
      const u = us.find(x => x.email === user.email);
      if (!u) throw new Error("Usuario no encontrado");
      
      const bs = DB.bookings();
      if (bs.some(b => b.email === u.email && b.slotISO === slotISO && b.status !== "canceled")) 
        throw new Error("Ya reservaste ese horario");
      if (capacityFor(slotISO, bs) >= CAPACITY) 
        throw new Error("Clase llena (6/6)");
      if (u.sessions <= 0) 
        throw new Error("No tienes sesiones disponibles");

      u.sessions -= 1;
      DB.saveUsers(us);
      bs.push({
        id: uid(),
        email: u.email,
        slotISO,
        status: "booked",
        bookedAt: localISO(new Date())
      });
      DB.saveBookings(bs);
    }

    function cancelBooking(id, userRole = "user") {
      const bs = DB.bookings();
      const b = bs.find(x => x.id === id);
      if (!b) throw new Error("Reserva no encontrada");
      if (b.status === "canceled") return;

      const us = DB.users();
      const u = us.find(x => x.email === b.email);
      const refundable = canChange(b) || userRole === "admin";
      
      b.status = "canceled";
      DB.saveBookings(bs);
      
      if (refundable && u) {
        u.sessions += 1;
        DB.saveUsers(us);
      }
    }

    function reschedule(id, newISO, userRole = "user") {
      const bs = DB.bookings();
      const b = bs.find(x => x.id === id);
      if (!b) throw new Error("Reserva no encontrada");
      
      if (userRole !== "admin" && !canChange(b)) 
        throw new Error("Solo puedes reprogramar con ‚â•24 h de anticipaci√≥n");
      if (capacityFor(newISO, bs) >= CAPACITY) 
        throw new Error("La clase destino est√° llena");
      if (bs.some(x => x.email === b.email && x.slotISO === newISO && x.status !== "canceled")) 
        throw new Error("Ya tienes esa hora reservada");

      b.slotISO = newISO;
      DB.saveBookings(bs);
    }

    function markAttendance(id, status) {
      const bs = DB.bookings();
      const b = bs.find(x => x.id === id);
      if (!b) throw new Error("Reserva no encontrada");
      if (!["booked", "attended", "missed"].includes(status)) 
        throw new Error("Estado inv√°lido");
      
      b.status = status;
      DB.saveBookings(bs);
    }

    function addSessions(email, n) {
      const us = DB.users();
      const u = us.find(x => x.email === email.trim().toLowerCase());
      if (!u) throw new Error("Usuario no encontrado");
      u.sessions = Math.max(0, (u.sessions || 0) + Number(n));
      DB.saveUsers(us);
    }

    function setSessions(email, val) {
      const us = DB.users();
      const u = us.find(x => x.email === email.trim().toLowerCase());
      if (!u) throw new Error("Usuario no encontrado");
      u.sessions = Math.max(0, Number(val) || 0);
      DB.saveUsers(us);
    }

    // ===== UI Components =====
    const Badge = ({children, variant = "default"}) => {
      const variants = {
        default: "bg-gray-100 text-gray-800 border-gray-200",
        success: "bg-green-100 text-green-800 border-green-200",
        warning: "bg-yellow-100 text-yellow-800 border-yellow-200",
        danger: "bg-red-100 text-red-800 border-red-200",
        info: "bg-blue-100 text-blue-800 border-blue-200"
      };
      return (
        <span className={`inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium ${variants[variant]}`}>
          {children}
        </span>
      );
    };

    const Section = ({title, right, children}) => (
      <div className="rounded-2xl shadow-lg p-6 bg-white border border-white/20">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-semibold text-gray-800">{title}</h2>
          {right}
        </div>
        {children}
      </div>
    );

    function LoginPage({onLogin}) {
      const [email, setEmail] = useState("");
      const [showDemo, setShowDemo] = useState(false);

      return (
        <div className="min-h-screen flex items-center justify-center p-4">
          <div className="w-full max-w-md">
            <div className="glass rounded-3xl p-8 shadow-2xl border border-white/20">
              <div className="text-center mb-8">
                <div className="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <span className="text-2xl">üßò‚Äç‚ôÄÔ∏è</span>
                </div>
                <h1 className="text-2xl font-bold text-white mb-2">Pilates Studio</h1>
                <p className="text-white/80 text-sm">Sistema de Reservas y Asistencia</p>
              </div>

              <div className="space-y-4">
                <div>
                  <label className="block text-white/90 text-sm font-medium mb-2">
                    Correo electr√≥nico
                  </label>
                  <input
                    type="email"
                    className="w-full px-4 py-3 rounded-xl border border-white/20 bg-white/10 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-white/30"
                    placeholder="tu@correo.com"
                    value={email}
                    onChange={e => setEmail(e.target.value)}
                  />
                </div>

                <button
                  className="w-full bg-white text-gray-800 font-semibold py-3 px-4 rounded-xl hover:bg-white/90 transition-all duration-200 transform hover:scale-105"
                  onClick={() => {
                    try {
                      onLogin(email);
                    } catch (e) {
                      alert(e.message);
                    }
                  }}
                >
                  Iniciar Sesi√≥n
                </button>

                <div className="text-center">
                  <button
                    className="text-white/80 text-sm hover:text-white transition-colors"
                    onClick={() => setShowDemo(!showDemo)}
                  >
                    {showDemo ? "Ocultar" : "Ver"} usuarios de prueba
                  </button>
                </div>

                {showDemo && (
                  <div className="bg-white/10 rounded-xl p-4 space-y-2">
                    <p className="text-white/90 text-sm font-medium mb-3">Usuarios de prueba:</p>
                    {TEST_USERS.map(user => (
                      <div key={user.email} className="flex items-center justify-between">
                        <div>
                          <div className="text-white text-sm font-medium">{user.name}</div>
                          <div className="text-white/70 text-xs">{user.email}</div>
                          <Badge variant={user.role === 'admin' ? 'danger' : user.role === 'instructor' ? 'warning' : 'info'}>
                            {user.role === 'admin' ? 'Administrador' : user.role === 'instructor' ? 'Instructor' : 'Cliente'}
                          </Badge>
                        </div>
                        <button
                          className="text-xs bg-white/20 text-white px-3 py-1 rounded-lg hover:bg-white/30 transition-colors"
                          onClick={() => setEmail(user.email)}
                        >
                          Usar
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function SlotsGrid({slots, bookings, onBook, currentUser}) {
      const grouped = useMemo(() => {
        const g = {};
        for (const s of slots) {
          const k = dayKey(parseLocalISO(s));
          (g[k] = g[k] || []).push(s);
        }
        return g;
      }, [slots]);

      return (
        <div className="space-y-6">
          {Object.entries(grouped).map(([d, list]) => (
            <div key={d}>
              <div className="text-sm font-medium text-gray-600 mb-3">
                {new Date(d).toLocaleDateString('es-ES', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}
              </div>
              <div className="grid sm:grid-cols-3 gap-4">
                {list.map(s => {
                  const cap = capacityFor(s, bookings);
                  const mine = bookings.some(b => b.email === currentUser?.email && b.slotISO === s && b.status !== "canceled");
                  const isFull = cap >= CAPACITY;
                  
                  return (
                    <div key={s} className={`rounded-xl border-2 p-4 transition-all duration-200 ${
                      mine ? 'bg-blue-50 border-blue-200' : 
                      isFull ? 'bg-gray-50 border-gray-200' : 
                      'bg-white border-gray-200 hover:border-blue-300 hover:shadow-md'
                    }`}>
                      <div className="flex items-center justify-between mb-3">
                        <div className="font-semibold text-gray-800">
                          {parseLocalISO(s).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'})}
                        </div>
                        <Badge variant={isFull ? "danger" : cap > 3 ? "warning" : "success"}>
                          {cap}/{CAPACITY}
                        </Badge>
                      </div>
                      <button
                        className={`w-full rounded-xl px-4 py-2 text-sm font-medium transition-all duration-200 ${
                          mine ? 'bg-blue-600 text-white cursor-default' :
                          isFull || !currentUser ? 'bg-gray-200 text-gray-500 cursor-not-allowed' :
                          'bg-blue-600 text-white hover:bg-blue-700 transform hover:scale-105'
                        }`}
                        disabled={isFull || mine || !currentUser || currentUser.role !== 'user'}
                        onClick={() => onBook(s)}
                      >
                        {mine ? "‚úì Reservado" : isFull ? "Clase llena" : "Reservar"}
                      </button>
                    </div>
                  );
                })}
              </div>
            </div>
          ))}
        </div>
      );
    }

    function MyBookings({user, bookings, allSlots, onCancel, onReschedule}) {
      const mine = bookings.filter(b => b.email === user?.email && b.status !== "canceled")
                           .sort((a, b) => parseLocalISO(a.slotISO) - parseLocalISO(b.slotISO));

      return (
        <div className="space-y-4">
          {mine.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              <span className="text-4xl mb-4 block">üìÖ</span>
              No tienes reservas activas
            </div>
          )}
          {mine.map(b => {
            const start = parseLocalISO(b.slotISO);
            const canEdit = canChange(b);
            const statusColors = {
              booked: "info",
              attended: "success",
              missed: "danger"
            };

            return (
              <div key={b.id} className="border-2 border-gray-200 rounded-xl p-4 hover:shadow-md transition-all duration-200">
                <div className="flex flex-wrap items-center justify-between gap-4">
                  <div className="space-y-2">
                    <div className="font-semibold text-gray-800">{fmt(start)}</div>
                    <Badge variant={statusColors[b.status] || "default"}>
                      {b.status === "booked" ? "Reservado" : 
                       b.status === "attended" ? "Asisti√≥" : 
                       b.status === "missed" ? "Falt√≥" : b.status}
                    </Badge>
                  </div>
                  <div className="flex flex-wrap items-center gap-2">
                    {canEdit && (
                      <select
                        className="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        defaultValue=""
                        onChange={e => {if (e.target.value) onReschedule(b, e.target.value)}}
                      >
                        <option value="">Reprogramar a‚Ä¶</option>
                        {allSlots.map(s => (
                          <option key={s} value={s}>{fmt(parseLocalISO(s))}</option>
                        ))}
                      </select>
                    )}
                    <button
                      className="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition-colors"
                      onClick={() => onCancel(b)}
                    >
                      Cancelar {canEdit ? "(regresa sesi√≥n)" : "(sin reembolso)"}
                    </button>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    function InstructorPanel({bookings, refresh, allSlots}) {
      const today = new Date();
      const todayKey = dayKey(today);
      const todayBookings = bookings.filter(b => {
        const slotDate = parseLocalISO(b.slotISO);
        return dayKey(slotDate) === todayKey && b.status !== "canceled";
      }).sort((a, b) => parseLocalISO(a.slotISO) - parseLocalISO(b.slotISO));

      const upcoming = bookings.filter(b => {
        const slotDate = parseLocalISO(b.slotISO);
        return slotDate > today && b.status !== "canceled";
      }).sort((a, b) => parseLocalISO(a.slotISO) - parseLocalISO(b.slotISO));

      return (
        <div className="space-y-6">
          <Section title="Clases de hoy" right={<Badge variant="info">{todayBookings.length} reservas</Badge>}>
            <div className="space-y-3">
              {todayBookings.length === 0 && (
                <div className="text-center py-6 text-gray-500">
                  <span className="text-3xl mb-2 block">‚òÄÔ∏è</span>
                  No hay clases programadas para hoy
                </div>
              )}
              {todayBookings.map(b => {
                const user = DB.users().find(u => u.email === b.email);
                return (
                  <div key={b.id} className="border rounded-xl p-4 flex items-center justify-between">
                    <div>
                      <div className="font-medium">{fmt(parseLocalISO(b.slotISO))}</div>
                      <div className="text-sm text-gray-600">{user?.name || b.email}</div>
                      <Badge variant={b.status === "attended" ? "success" : b.status === "missed" ? "danger" : "info"}>
                        {b.status === "booked" ? "Pendiente" : 
                         b.status === "attended" ? "Asisti√≥" : "Falt√≥"}
                      </Badge>
                    </div>
                    <div className="flex gap-2">
                      <button
                        className="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition-colors"
                        onClick={() => {markAttendance(b.id, "attended"); refresh();}}
                      >
                        ‚úì Asisti√≥
                      </button>
                      <button
                        className="bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition-colors"
                        onClick={() => {markAttendance(b.id, "missed"); refresh();}}
                      >
                        ‚úó Falt√≥
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          </Section>

          <Section title="Pr√≥ximas clases" right={<Badge variant="info">{upcoming.length} reservas</Badge>}>
            <div className="space-y-3 max-h-96 overflow-y-auto">
              {upcoming.slice(0, 10).map(b => {
                const user = DB.users().find(u => u.email === b.email);
                return (
                  <div key={b.id} className="border rounded-xl p-3 flex items-center justify-between">
                    <div>
                      <div className="font-medium text-sm">{fmt(parseLocalISO(b.slotISO))}</div>
                      <div className="text-xs text-gray-600">{user?.name || b.email}</div>
                    </div>
                    <Badge variant="info">Reservado</Badge>
                  </div>
                );
              })}
            </div>
          </Section>
        </div>
      );
    }

    function AdminPanel({users, bookings, refresh, allSlots}) {
      const [email, setEmail] = useState("");
      const [delta, setDelta] = useState(4);
      const [fix, setFix] = useState("");

      const future = bookings.filter(b => parseLocalISO(b.slotISO) >= new Date())
                             .sort((a, b) => parseLocalISO(a.slotISO) - parseLocalISO(b.slotISO));

      return (
        <div className="space-y-6">
          <Section title="Gesti√≥n de Paquetes">
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
              <h3 className="font-medium text-blue-800 mb-2">Asignar sesiones a usuarios</h3>
              <div className="flex flex-wrap items-end gap-3">
                <div className="flex flex-col">
                  <label className="text-xs text-gray-600 mb-1">Correo del usuario</label>
                  <input
                    className="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="cliente@correo.com"
                    value={email}
                    onChange={e => setEmail(e.target.value)}
                  />
                </div>
                <div className="flex flex-col">
                  <label className="text-xs text-gray-600 mb-1">Agregar sesiones (+)</label>
                  <input
                    type="number"
                    className="border border-gray-300 rounded-lg px-3 py-2 w-28 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={delta}
                    onChange={e => setDelta(e.target.value)}
                  />
                </div>
                <button
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                  onClick={() => {
                    try {
                      addSessions(email, delta);
                      refresh();
                      alert("Sesiones agregadas correctamente");
                    } catch (e) {
                      alert(e.message);
                    }
                  }}
                >
                  Agregar
                </button>
                <div className="text-sm text-gray-400">o</div>
                <div className="flex flex-col">
                  <label className="text-xs text-gray-600 mb-1">Fijar total (=)</label>
                  <input
                    type="number"
                    className="border border-gray-300 rounded-lg px-3 py-2 w-28 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    value={fix}
                    onChange={e => setFix(e.target.value)}
                  />
                </div>
                <button
                  className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors"
                  onClick={() => {
                    try {
                      setSessions(email, fix);
                      refresh();
                      alert("Sesiones actualizadas correctamente");
                    } catch (e) {
                      alert(e.message);
                    }
                  }}
                >
                  Fijar
                </button>
              </div>
            </div>
          </Section>

          <Section title="Gesti√≥n de Reservas" right={<Badge variant="info">{future.length} reservas futuras</Badge>}>
            <div className="space-y-3">
              {future.length === 0 && (
                <div className="text-center py-6 text-gray-500">
                  <span className="text-3xl mb-2 block">üìã</span>
                  No hay reservas futuras
                </div>
              )}
              {future.map(b => {
                const user = users.find(u => u.email === b.email);
                return (
                  <div key={b.id} className="border-2 border-gray-200 rounded-xl p-4">
                    <div className="flex flex-wrap items-center justify-between gap-4">
                      <div className="space-y-1">
                        <div className="font-semibold">{fmt(parseLocalISO(b.slotISO))}</div>
                        <div className="text-sm text-gray-600">{user?.name || b.email}</div>
                        <Badge variant={b.status === "attended" ? "success" : b.status === "missed" ? "danger" : "info"}>
                          {b.status === "booked" ? "Reservado" : 
                           b.status === "attended" ? "Asisti√≥" : "Falt√≥"}
                        </Badge>
                      </div>
                      <div className="flex flex-wrap items-center gap-2">
                        <button
                          className="bg-green-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-green-600 transition-colors"
                          onClick={() => {markAttendance(b.id, "attended"); refresh();}}
                        >
                          ‚úì Asisti√≥
                        </button>
                        <button
                          className="bg-red-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-600 transition-colors"
                          onClick={() => {markAttendance(b.id, "missed"); refresh();}}
                        >
                          ‚úó Falt√≥
                        </button>
                        <select
                          className="border border-gray-300 rounded-lg px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                          defaultValue=""
                          onChange={e => {
                            if (!e.target.value) return;
                            try {
                              reschedule(b.id, e.target.value, "admin");
                              refresh();
                            } catch (err) {
                              alert(err.message);
                            }
                          }}
                        >
                          <option value="">Reprogramar‚Ä¶</option>
                          {allSlots.map(s => (
                            <option key={s} value={s}>{fmt(parseLocalISO(s))}</option>
                          ))}
                        </select>
                        <button
                          className="bg-gray-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-600 transition-colors"
                          onClick={() => {cancelBooking(b.id, "admin"); refresh();}}
                        >
                          Cancelar
                        </button>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </Section>

          <Section title="Usuarios Registrados" right={<Badge variant="info">{users.length} usuarios</Badge>}>
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
              {users.map(u => (
                <div key={u.email} className="border-2 border-gray-200 rounded-xl p-4 hover:shadow-md transition-all duration-200">
                  <div className="space-y-2">
                    <div className="font-semibold text-gray-800">{u.name || u.email}</div>
                    <div className="text-xs text-gray-500">{u.email}</div>
                    <div className="flex items-center justify-between">
                      <Badge variant={u.role === 'admin' ? 'danger' : u.role === 'instructor' ? 'warning' : 'info'}>
                        {u.role === 'admin' ? 'Admin' : u.role === 'instructor' ? 'Instructor' : 'Cliente'}
                      </Badge>
                      <div className="text-sm">
                        <span className="text-gray-600">Sesiones:</span>
                        <span className="font-bold ml-1 text-blue-600">{u.sessions || 0}</span>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </Section>
        </div>
      );
    }

    function App() {
      const slots = useMemo(() => generateSlots(), []);
      const {user, login, logout, reload} = useAuth();
      const [bookings, setBookings] = useState(DB.bookings());
      const [users, setUsers] = useState(DB.users());

      const refresh = () => {
        setBookings(DB.bookings());
        setUsers(DB.users());
        reload();
      };

      const handleBook = s => {
        try {
          book(user, s);
          refresh();
          alert("¬°Reserva creada exitosamente!");
        } catch (e) {
          alert(e.message);
        }
      };

      const handleCancel = b => {
        try {
          cancelBooking(b.id, user?.role);
          refresh();
        } catch (e) {
          alert(e.message);
        }
      };

      const handleReschedule = (b, newISO) => {
        try {
          reschedule(b.id, newISO, user?.role);
          refresh();
        } catch (e) {
          alert(e.message);
        }
      };

      if (!user) {
        return <LoginPage onLogin={login} />;
      }

      const getAvailableTabs = () => {
        const tabs = [];
        if (user.role === 'user') {
          tabs.push(
            {id: "reservar", label: "Reservar Clases", icon: "üìÖ"},
            {id: "mis-reservas", label: "Mis Reservas", icon: "üìã"}
          );
        }
        if (user.role === 'instructor') {
          tabs.push(
            {id: "asistencia", label: "Tomar Asistencia", icon: "‚úÖ"}
          );
        }
        if (user.role === 'admin') {
          tabs.push(
            {id: "reservar", label: "Reservar Clases", icon: "üìÖ"},
            {id: "mis-reservas", label: "Mis Reservas", icon: "üìã"},
            {id: "asistencia", label: "Tomar Asistencia", icon: "‚úÖ"},
            {id: "admin", label: "Administraci√≥n", icon: "‚öôÔ∏è"}
          );
        }
        return tabs;
      };

      const availableTabs = getAvailableTabs();
      const [tab, setTab] = useState(availableTabs[0]?.id || "reservar");

      return (
        <div className="min-h-screen p-4 sm:p-6 md:p-8">
          <div className="max-w-6xl mx-auto space-y-6">
            <header className="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h1 className="text-3xl font-bold text-white mb-2">Pilates Studio</h1>
                <p className="text-white/80 text-sm">Sistema de Reservas y Asistencia</p>
              </div>
              <div className="flex items-center gap-4">
                <div className="text-right">
                  <div className="text-white font-medium">Hola, {user.name}</div>
                  <div className="text-white/80 text-sm">
                    <Badge variant={user.role === 'admin' ? 'danger' : user.role === 'instructor' ? 'warning' : 'info'}>
                      {user.role === 'admin' ? 'Administrador' : user.role === 'instructor' ? 'Instructor' : 'Cliente'}
                    </Badge>
                    {user.role === 'user' && (
                      <span className="ml-2">
                        <span className="font-mono">{user.sessions || 0}</span> sesiones
                      </span>
                    )}
                  </div>
                </div>
                <button
                  className="bg-white/20 text-white px-4 py-2 rounded-xl text-sm hover:bg-white/30 transition-colors"
                  onClick={logout}
                >
                  Cerrar Sesi√≥n
                </button>
              </div>
            </header>

            <nav className="flex flex-wrap items-center gap-2">
              {availableTabs.map(x => (
                <button
                  key={x.id}
                  className={`px-4 py-3 rounded-xl text-sm font-medium transition-all duration-200 ${
                    tab === x.id 
                      ? 'bg-white text-gray-800 shadow-lg transform scale-105' 
                      : 'bg-white/20 text-white hover:bg-white/30'
                  }`}
                  onClick={() => setTab(x.id)}
                >
                  <span className="mr-2">{x.icon}</span>
                  {x.label}
                </button>
              ))}
            </nav>

            <div className="space-y-6">
              {tab === "reservar" && (
                <Section title="Calendario de Clases" right={<Badge variant="info">Capacidad {CAPACITY} por clase</Badge>}>
                  {user.role === 'user' && user.sessions <= 0 && (
                    <div className="mb-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded-lg p-3">
                      ‚ö†Ô∏è No tienes sesiones disponibles. Contacta al administrador para adquirir un paquete.
                    </div>
                  )}
                  <SlotsGrid slots={slots} bookings={bookings} onBook={handleBook} currentUser={user} />
                </Section>
              )}

              {tab === "mis-reservas" && (
                <Section title="Tus Reservas">
                  <MyBookings user={user} bookings={bookings} allSlots={slots} onCancel={handleCancel} onReschedule={handleReschedule} />
                </Section>
              )}

              {tab === "asistencia" && (user.role === 'instructor' || user.role === 'admin') && (
                <InstructorPanel bookings={bookings} refresh={refresh} allSlots={slots} />
              )}

              {tab === "admin" && user.role === 'admin' && (
                <AdminPanel users={users} bookings={bookings} refresh={refresh} allSlots={slots} />
              )}
            </div>

            <footer className="text-xs text-white/60 pt-6 text-center">
              <p>Demo del sistema de reservas ‚Ä¢ Para producci√≥n se requiere backend con base de datos y notificaciones por email</p>
            </footer>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>